<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Massive.js by dmfay</title>

    <link rel="stylesheet" href="/massive-js/assets/css/style.css?v=8f3b5004dbc09941550749da6d7e90b279e958cc">
    <link rel="stylesheet" href="/assets/css/custom.css">
    <meta name="viewport" content="width=device-width">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1><a href="/massive-js">Massive.js</a></h1>
        <p>Massive.js is a data mapper for Node.js that goes all in on PostgreSQL and fully embraces the power and flexibility of the SQL language and relational metaphors. Providing minimal abstractions for the interfaces and tools you already use, its goal is to do just enough to make working with your data as easy and intuitive as possible, then get out of your way.
</p>

        
          <p class="view"><a href="http://github.com/dmfay/massive-js">View the Project on GitHub <small></small></a></p>
        

        <h2>Contents</h2>
        <ul class="toc">
          <li><a href="/massive-js/connecting.html">Connecting</a></li>
          <li><a href="/massive-js/criteria.html">Criteria Objects</a></li>
          <li><a href="/massive-js/queries.html">Queries</a></li>
          <li><a href="/massive-js/persistence.html">Persistence</a></li>
          <li><a href="/massive-js/documents.html">Working with Documents</a></li>
          <li><a href="/massive-js/functions.html">Functions and Scripts</a></li>
          <li><a href="/massive-js/run.html">Raw SQL</a></li>
          <li><a href="/massive-js/api/index.html">API Docs</a></li>
        </ul>

        

        
        <p>This project is maintained by <a href="http://github.com/dmfay">dmfay</a></p>
        
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>

        
      </header>
      <section>

      <h1 id="working-with-documents">Working With Documents</h1>

<p>Around the late 00s, document databases like MongoDB or CouchDB started to be hailed as the next big thing. Modeling data in groups of hierarchies rather than as flat related sets, they made an enormous difference in how applications approached data. Although they were never going to <em>replace</em> relational databases, there are many use cases for which document stores are undeniably better-suited than the traditional RDBMS, so document databases are an important class of datastore in their own right.</p>

<p>PostgreSQL’s JSONB functionality allows us to blend relational and document approaches by storing JSON documents in traditional tables. There’s a lot to recommend a hybrid data model: in modern applications, a greater or lesser proportion of the data is relational and should be stored and accessed as such, but there’s often some information that really is best represented as a rich, nested document with a flexible schema. In pure relational terms, data like this can only be represented through tortuous abstractions (if you’ve never seen a table with a self-joining foreign key representing a hierarchy, consider yourself fortunate) or as unsearchable, unindexable long text or BLOB fields.</p>

<p>The JSONB type is a great solution to this problem, and Massive takes care of the management overhead with a document table API.</p>

<h2 id="document-tables">Document Tables</h2>

<p>Document tables exist for the sole purpose of storing JSONB data. Query them through Massive’s API, and you get a JSON document which you can modify and persist, all seamlessly. You don’t even need to create them ahead of time until you know you need them.</p>

<p>Document tables may be extended with new columns and foreign keys. The <code class="highlighter-rouge">id</code> type can be changed as well (so long as a default is set such as <code class="highlighter-rouge">uuid_generate_v1mc()</code> for UUID types) without impeding usage of document table functions. Just don’t <em>remove</em> any columns or change their names, since Massive depends on those.</p>

<p>Standard table functions still work on document tables, and can be quite useful especially for extended document tables! Fields in the document can be searched with regular <code class="highlighter-rouge">find</code> and criteria object fields using JSON traversal to look for <code class="highlighter-rouge">body -&gt;&gt; myField</code>. <code class="highlighter-rouge">findDoc</code> <strong>is still preferred</strong> to JSON queries if at all possible since it uses the <code class="highlighter-rouge">@&gt;</code> “contains” operator to leverage indexing on the document body to improve performance.</p>

<h3 id="dbsavedoc">db.saveDoc</h3>

<p>The connected database instance has a <code class="highlighter-rouge">saveDoc</code> function. Passed a collection name (which can include a non-public schema) and a JavaScript object, this will create the table if it doesn’t already exist and write the object to it.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">db</span><span class="p">.</span><span class="nx">saveDoc</span><span class="p">(</span><span class="s1">'reports'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">title</span><span class="p">:</span> <span class="s1">'Week 12 Throughput'</span><span class="p">,</span>
  <span class="na">lines</span><span class="p">:</span> <span class="p">[{</span>
    <span class="na">name</span><span class="p">:</span> <span class="s1">'1 East'</span><span class="p">,</span>
    <span class="na">numbers</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="s1">'2 East'</span><span class="p">,</span>
    <span class="na">numbers</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
  <span class="p">}]</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">report</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// the reports table has been created and the initial document</span>
  <span class="c1">// is assigned a primary key value and returned</span>
<span class="p">});</span>
</code></pre>
</div>

<p>If the table already exists, you can still use <code class="highlighter-rouge">db.saveDoc</code>, but you can also invoke <code class="highlighter-rouge">saveDoc</code> on the table itself.</p>

<h2 id="querying-documents">Querying Documents</h2>

<h3 id="countdoc">countDoc</h3>

<p>Like its counterpart, <code class="highlighter-rouge">countDoc</code> returns the number of extant documents matching a criteria object. Unlike <code class="highlighter-rouge">count</code>, <code class="highlighter-rouge">countDoc</code> does not accept a raw SQL <code class="highlighter-rouge">WHERE</code> definition.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">db</span><span class="p">.</span><span class="nx">reports</span><span class="p">.</span><span class="nx">countDoc</span><span class="p">({</span>
  <span class="s1">'title ilike'</span><span class="p">:</span> <span class="s1">'%throughput%'</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">reports</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// number of matching documents</span>
<span class="p">});</span>
</code></pre>
</div>

<h3 id="finddoc">findDoc</h3>

<p><code class="highlighter-rouge">findDoc</code> locates documents with either a criteria object or a primary key. Simple criteria objects (testing equality only) can leverage the GIN index on the table to improve query speed.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">db</span><span class="p">.</span><span class="nx">reports</span><span class="p">.</span><span class="nx">findDoc</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">report</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// the report document body with the primary key included</span>
<span class="p">});</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">reports</span><span class="p">.</span><span class="nx">findDoc</span><span class="p">({</span>
  <span class="s1">'title ilike'</span><span class="p">:</span> <span class="s1">'%throughput%'</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">reports</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// all report documents matching the criteria</span>
<span class="p">});</span>
</code></pre>
</div>

<h3 id="searchdoc">searchDoc</h3>

<p><code class="highlighter-rouge">searchDoc</code> performs a full-text search on the document body fields.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">db</span><span class="p">.</span><span class="nx">reports</span><span class="p">.</span><span class="nx">searchDoc</span><span class="p">({</span>
  <span class="na">fields</span><span class="p">:</span> <span class="p">[</span><span class="s2">"title"</span><span class="p">,</span> <span class="s2">"description"</span><span class="p">],</span>
  <span class="na">term</span><span class="p">:</span> <span class="s2">"Kauai"</span>
<span class="p">}.</span><span class="nx">then</span><span class="p">(</span><span class="nx">docs</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// reports returned with an on-the-fly full text search</span>
  <span class="c1">// for 'Kauai'</span>
<span class="p">});</span>
</code></pre>
</div>

<h2 id="persisting-documents">Persisting Documents</h2>

<h3 id="savedoc">saveDoc</h3>

<p><code class="highlighter-rouge">saveDoc</code> inserts or updates a document. If an <code class="highlighter-rouge">id</code> field is present in the document, the corresponding record will be updated; otherwise, it’s inserted. <code class="highlighter-rouge">saveDoc</code> will replace the entire document and does not update individual fields; to do that, see <code class="highlighter-rouge">modify</code>.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">db</span><span class="p">.</span><span class="nx">reports</span><span class="p">.</span><span class="nx">saveDoc</span><span class="p">({</span>
  <span class="na">title</span><span class="p">:</span> <span class="s1">'Week 12 Throughput'</span><span class="p">,</span>
  <span class="na">lines</span><span class="p">:</span> <span class="p">[{</span>
    <span class="na">name</span><span class="p">:</span> <span class="s1">'1 East'</span><span class="p">,</span>
    <span class="na">numbers</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="s1">'2 East'</span><span class="p">,</span>
    <span class="na">numbers</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
  <span class="p">}]</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">report</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// the newly created report</span>
<span class="p">});</span>
</code></pre>
</div>

<h3 id="modify">modify</h3>

<p><code class="highlighter-rouge">modify</code> adds and updates fields in an existing document <em>without</em> replacing the entire body. Fields not defined in the <code class="highlighter-rouge">changes</code> object are not modified.</p>

<p>This function may be used with any JSON or JSONB column, not just with document tables. If used on a document table, it returns a promise for the updated document; otherwise, it will return the entire row.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">db</span><span class="p">.</span><span class="nx">reports</span><span class="p">.</span><span class="nx">modify</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">title</span><span class="p">:</span> <span class="s1">'Week 11 Throughput'</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">report</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// the updated report, with a changed 'title' attribute</span>
<span class="p">});</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">products</span><span class="p">.</span><span class="nx">modify</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">colors</span><span class="p">:</span> <span class="p">[</span><span class="s1">'gray'</span><span class="p">,</span> <span class="s1">'purple'</span><span class="p">,</span> <span class="s1">'red'</span><span class="p">]</span>
<span class="p">},</span> <span class="s1">'info'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">widget</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// the product with an 'info' field containing the colors array</span>
<span class="p">});</span>
</code></pre>
</div>


      </section>
    </div>
    <script src="/massive-js/assets/js/scale.fix.js"></script>


  
  </body>
</html>

