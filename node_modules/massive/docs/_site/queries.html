<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Massive.js by dmfay</title>

    <link rel="stylesheet" href="/massive-js/assets/css/style.css?v=8f3b5004dbc09941550749da6d7e90b279e958cc">
    <link rel="stylesheet" href="/assets/css/custom.css">
    <meta name="viewport" content="width=device-width">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1><a href="/massive-js">Massive.js</a></h1>
        <p>Massive.js is a data mapper for Node.js that goes all in on PostgreSQL and fully embraces the power and flexibility of the SQL language and relational metaphors. Providing minimal abstractions for the interfaces and tools you already use, its goal is to do just enough to make working with your data as easy and intuitive as possible, then get out of your way.
</p>

        
          <p class="view"><a href="http://github.com/dmfay/massive-js">View the Project on GitHub <small></small></a></p>
        

        <h2>Contents</h2>
        <ul class="toc">
          <li><a href="/massive-js/connecting.html">Connecting</a></li>
          <li><a href="/massive-js/criteria.html">Criteria Objects</a></li>
          <li><a href="/massive-js/queries.html">Queries</a></li>
          <li><a href="/massive-js/persistence.html">Persistence</a></li>
          <li><a href="/massive-js/documents.html">Working with Documents</a></li>
          <li><a href="/massive-js/functions.html">Functions and Scripts</a></li>
          <li><a href="/massive-js/run.html">Raw SQL</a></li>
          <li><a href="/massive-js/api/index.html">API Docs</a></li>
        </ul>

        

        
        <p>This project is maintained by <a href="http://github.com/dmfay">dmfay</a></p>
        
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>

        
      </header>
      <section>

      <h1 id="queries">Queries</h1>

<p>Since Massive doesn’t use models, data is retrieved as plain old JavaScript objects where keys correspond to column names. With the obvious exception of <code class="highlighter-rouge">findOne</code>, most query functions return arrays where each object represents a row in the resultset <em>even if</em> there is only one result whether naturally or from a <code class="highlighter-rouge">LIMIT</code> clause applied by query options.</p>

<p>The <code class="highlighter-rouge">find</code>, <code class="highlighter-rouge">findOne</code>, and <code class="highlighter-rouge">count</code> functions form a consistent API for data retrieval with criteria and options. <code class="highlighter-rouge">where</code> offers total flexibility if you need to hand-write a <code class="highlighter-rouge">WHERE</code> clause for cases where criteria objects aren’t sufficient (for example, anything involving operations on a field). <code class="highlighter-rouge">search</code> handles full-text search across multiple columns.</p>

<h2 id="query-options">Query Options</h2>

<p>The options object modifies query behavior, either by applying additional clauses to the query itself or by altering the results.</p>

<h3 id="sql-clauses">SQL Clauses</h3>

<table>
  <thead>
    <tr>
      <th>Option key</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>columns</td>
      <td>Change the <code class="highlighter-rouge">SELECT</code> list by specifying an array of columns to include in the resultset.</td>
    </tr>
    <tr>
      <td>limit</td>
      <td>Set the number of rows to take.</td>
    </tr>
    <tr>
      <td>offset</td>
      <td>Set the number of rows to skip.</td>
    </tr>
    <tr>
      <td>only</td>
      <td>Set to <code class="highlighter-rouge">true</code> to restrict the query to the table specified, if any others inherit from it.</td>
    </tr>
    <tr>
      <td>order</td>
      <td>An array of strings (<code class="highlighter-rouge">['column1', 'column2 DESC']</code>) which is processed into an <code class="highlighter-rouge">ORDER BY</code> clause.</td>
    </tr>
    <tr>
      <td>orderBody</td>
      <td>If querying a document table, set to <code class="highlighter-rouge">true</code> to apply <code class="highlighter-rouge">options.order</code> to fields in the document body rather than the table.</td>
    </tr>
  </tbody>
</table>

<p><em>nb. The <code class="highlighter-rouge">columns</code> and <code class="highlighter-rouge">order</code> properties allow comma-delimited string as well as array values. Take care when using raw strings since the values are interpolated directly into the emitted SQL. If user input is included in the values, you open yourself up to SQL injection attacks.</em></p>

<h3 id="results-processing">Results Processing</h3>

<table>
  <thead>
    <tr>
      <th>Option key</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>build</td>
      <td>Set to <code class="highlighter-rouge">true</code> to return the query text and parameters <em>without</em> executing anything.</td>
    </tr>
    <tr>
      <td>document</td>
      <td>Set to <code class="highlighter-rouge">true</code> to invoke document table handling.</td>
    </tr>
    <tr>
      <td>single</td>
      <td>Set to <code class="highlighter-rouge">true</code> to return the first result as an object instead of a results array.</td>
    </tr>
    <tr>
      <td>stream</td>
      <td>Set to <code class="highlighter-rouge">true</code> to return results as a stream instead of an array.</td>
    </tr>
  </tbody>
</table>

<h2 id="find">find</h2>

<p><code class="highlighter-rouge">find</code> is the workhorse of the query functions. Given criteria and options (both optional, in which case it queries the full table) it returns a Promise for a results array.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">db</span><span class="p">.</span><span class="nx">tests</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
  <span class="na">is_active</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="na">offset</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
  <span class="na">limit</span><span class="p">:</span> <span class="mi">10</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">tests</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// active tests 21-30</span>
<span class="p">});</span>
</code></pre>
</div>

<h2 id="findone">findOne</h2>

<p><code class="highlighter-rouge">findOne</code> is a convenient alias for <code class="highlighter-rouge">find</code> with <code class="highlighter-rouge">options.single</code> set. An options object may still be passed.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">db</span><span class="p">.</span><span class="nx">tests</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span>
  <span class="na">id</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="na">columns</span><span class="p">:</span> <span class="p">[</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'is_active'</span><span class="p">]</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// an object with the name and active status for test #1</span>
<span class="p">});</span>
</code></pre>
</div>

<p>You can use a primary key value instead of a criteria object with <code class="highlighter-rouge">findOne</code> if desired.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">db</span><span class="p">.</span><span class="nx">tests</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">columns</span><span class="p">:</span> <span class="p">[</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'is_active'</span><span class="p">]</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// an object with the name and active status for test #1</span>
<span class="p">});</span>
</code></pre>
</div>

<h2 id="count">count</h2>

<p><code class="highlighter-rouge">count</code> returns the number of rows matching the criteria object. Since PostgreSQL uses 64-bit integers and JavaScript’s Number type only has 53 bits of precision, the result will actually come back as a String rather than a Number.</p>

<p><code class="highlighter-rouge">count</code> does <em>not</em> take an options object, since there are no useful options a user might set.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">db</span><span class="p">.</span><span class="nx">tests</span><span class="p">.</span><span class="nx">count</span><span class="p">({</span>
  <span class="na">is_active</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">total</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// the number of active tests</span>
<span class="p">});</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">count</code> may also be invoked with a <code class="highlighter-rouge">where</code>-style prepared statement and parameters.</p>

<h2 id="where">where</h2>

<p><code class="highlighter-rouge">where</code> lets you write your own prepared statement-style <code class="highlighter-rouge">WHERE</code> clause. While the criteria object is extremely flexible, it does have limitations: it won’t perform operations such as <code class="highlighter-rouge">LEFT()</code> or <code class="highlighter-rouge">SUBSTRING()</code>, it can’t set up subqueries, and so forth. For those contingencies, or if you just really want to write it yourself (we don’t judge), there’s <code class="highlighter-rouge">where</code>.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">db</span><span class="p">.</span><span class="nx">tests</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span>
  <span class="s1">'id IN (SELECT test_id FROM user_tests WHERE user_id = $1)'</span><span class="p">,</span>
  <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">tests</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// all of user 1's tests</span>
<span class="p">});</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">where</code> can use named parameters; just pass in an object instead of an array for the function’s second argument.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">db</span><span class="p">.</span><span class="nx">tests</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span>
  <span class="s1">'id IN (SELECT test_id FROM user_tests WHERE user_id = ${id})'</span><span class="p">,</span>
  <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">tests</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// all of user 1's tests</span>
<span class="p">});</span>
</code></pre>
</div>

<h2 id="search">search</h2>

<p><code class="highlighter-rouge">search</code> enables full-text searching across multiple columns. The first argument is a search plan with an array of <code class="highlighter-rouge">columns</code> and a <code class="highlighter-rouge">term</code> to search for. The function also takes a query options object as an optional second argument.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span>
  <span class="p">{</span><span class="na">fields</span><span class="p">:</span> <span class="p">[</span><span class="s1">'email'</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">],</span> <span class="na">term</span><span class="p">:</span> <span class="s1">'rob'</span><span class="p">},</span>
  <span class="p">{</span><span class="na">stream</span><span class="p">:</span> <span class="kc">true</span><span class="p">}</span>
<span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">stream</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// a readable stream of users matching the full-text</span>
  <span class="c1">// search condition</span>
<span class="p">});</span>
</code></pre>
</div>


      </section>
    </div>
    <script src="/massive-js/assets/js/scale.fix.js"></script>


  
  </body>
</html>

